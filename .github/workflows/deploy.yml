name: Deploy Hello World API

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

# Required for OIDC authentication and release creation
permissions:
  id-token: write
  contents: write  # Required for creating releases

env:
  AWS_REGION: ap-southeast-2
  NODE_VERSION: '20.x'

jobs:
  # Run unit tests
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm test

      - name: Generate coverage report
        run: npm run coverage

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/

      - name: Check coverage threshold
        run: |
          COVERAGE=$(npm run coverage 2>&1 | grep "All files" | awk '{print $10}' | sed 's/%//')
          echo "Code coverage: ${COVERAGE}%"
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "Coverage is below 80% threshold"
            exit 1
          fi

  # Deploy to development environment
  deploy-dev:
    name: Deploy to Development
    needs: test
    if: github.ref == 'refs/heads/develop' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    environment:
      name: development
      url: ${{ steps.deploy.outputs.api_endpoint }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python for SAM
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Setup SAM CLI
        uses: aws-actions/setup-sam@v2
        with:
          use-installer: true

      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Build SAM application
        run: sam build

      - name: Deploy to Development
        id: deploy
        run: |
          sam deploy \
            --stack-name aws-hello-world-api-dev \
            --capabilities CAPABILITY_IAM \
            --parameter-overrides Environment=dev ApiVersion=${{ github.sha }} \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --resolve-s3

          # Extract API endpoint from deployment output
          API_ENDPOINT=$(aws cloudformation describe-stacks \
            --stack-name aws-hello-world-api-dev \
            --query 'Stacks[0].Outputs[?OutputKey==`HelloWorldApi`].OutputValue' \
            --output text)

          echo "api_endpoint=$API_ENDPOINT" >> $GITHUB_OUTPUT
          echo "### Deployed to Development" >> $GITHUB_STEP_SUMMARY
          echo "API Endpoint: $API_ENDPOINT" >> $GITHUB_STEP_SUMMARY

      - name: Smoke test
        run: |
          API_ENDPOINT="${{ steps.deploy.outputs.api_endpoint }}"
          echo "Testing API at: $API_ENDPOINT"

          # Test hello endpoint
          HELLO_RESPONSE=$(curl -s "$API_ENDPOINT/hello")
          echo "Hello endpoint response: $HELLO_RESPONSE"
          echo "$HELLO_RESPONSE" | grep -q "Hello World!" || exit 1

          # Test health endpoint
          HEALTH_RESPONSE=$(curl -s "$API_ENDPOINT/health")
          echo "Health endpoint response: $HEALTH_RESPONSE"
          echo "$HEALTH_RESPONSE" | grep -q "healthy" || exit 1

  # Deploy to staging environment
  deploy-staging:
    name: Deploy to Staging
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: ${{ steps.deploy.outputs.api_endpoint }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python for SAM
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Setup SAM CLI
        uses: aws-actions/setup-sam@v2
        with:
          use-installer: true

      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Build SAM application
        run: sam build

      - name: Deploy to Staging
        id: deploy
        run: |
          sam deploy \
            --stack-name aws-hello-world-api-staging \
            --capabilities CAPABILITY_IAM \
            --parameter-overrides Environment=staging ApiVersion=${{ github.sha }} \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --resolve-s3

          # Extract API endpoint
          API_ENDPOINT=$(aws cloudformation describe-stacks \
            --stack-name aws-hello-world-api-staging \
            --query 'Stacks[0].Outputs[?OutputKey==`HelloWorldApi`].OutputValue' \
            --output text)

          echo "api_endpoint=$API_ENDPOINT" >> $GITHUB_OUTPUT
          echo "### Deployed to Staging" >> $GITHUB_STEP_SUMMARY
          echo "API Endpoint: $API_ENDPOINT" >> $GITHUB_STEP_SUMMARY

      - name: Run integration tests
        run: |
          API_ENDPOINT="${{ steps.deploy.outputs.api_endpoint }}"

          # Warmup request to avoid Lambda cold start affecting performance test
          echo "Warming up Lambda..."
          warmup_time=$(curl -o /dev/null -s -w '%{time_total}\n' "$API_ENDPOINT/hello")
          echo "Warmup request: ${warmup_time}s (cold start expected)"

          # Performance test (now with warm Lambda)
          echo "Running performance test on warm Lambda..."

          # Track total time for average calculation
          total_time=0
          slow_requests=0

          for i in {1..10}; do
            response_time=$(curl -o /dev/null -s -w '%{time_total}\n' "$API_ENDPOINT/hello")
            echo "Request $i: ${response_time}s"

            # Track statistics
            total_time=$(echo "$total_time + $response_time" | bc -l)
            if (( $(echo "$response_time > 0.5" | bc -l) )); then
              slow_requests=$((slow_requests + 1))
              echo "  ⚠️  Slow request (>500ms)"
            fi
          done

          # Calculate and display average
          avg_time=$(echo "scale=3; $total_time / 10" | bc -l)
          echo "Average response time: ${avg_time}s"
          echo "Slow requests (>500ms): $slow_requests/10"

          # Only fail if performance is severely degraded (avg > 1s or all requests slow)
          if (( $(echo "$avg_time > 1.0" | bc -l) )); then
            echo "❌ Average response time exceeds 1 second - performance severely degraded"
            exit 1
          fi

  # Deploy to production environment (requires manual approval)
  deploy-prod:
    name: Deploy to Production
    needs: deploy-staging
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: ${{ steps.deploy.outputs.api_endpoint }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python for SAM
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Setup SAM CLI
        uses: aws-actions/setup-sam@v2
        with:
          use-installer: true

      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Build SAM application
        run: sam build

      - name: Deploy to Production
        id: deploy
        run: |
          sam deploy \
            --stack-name aws-hello-world-api-prod \
            --capabilities CAPABILITY_IAM \
            --parameter-overrides Environment=prod ApiVersion=${{ github.sha }} \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --resolve-s3

          # Extract API endpoint
          API_ENDPOINT=$(aws cloudformation describe-stacks \
            --stack-name aws-hello-world-api-prod \
            --query 'Stacks[0].Outputs[?OutputKey==`HelloWorldApi`].OutputValue' \
            --output text)

          echo "api_endpoint=$API_ENDPOINT" >> $GITHUB_OUTPUT
          echo "### Deployed to Production 🚀" >> $GITHUB_STEP_SUMMARY
          echo "API Endpoint: $API_ENDPOINT" >> $GITHUB_STEP_SUMMARY
          echo "Version: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

      - name: Verify production deployment
        run: |
          API_ENDPOINT="${{ steps.deploy.outputs.api_endpoint }}"

          # Verify endpoints are responding
          for endpoint in "/hello" "/health"; do
            echo "Testing $endpoint..."
            response=$(curl -s -o /dev/null -w "%{http_code}" "$API_ENDPOINT$endpoint")
            if [ "$response" != "200" ]; then
              echo "Production endpoint $endpoint returned $response"
              exit 1
            fi
          done

          echo "✅ Production deployment verified successfully"

      - name: Create release
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "v${{ github.run_number }}" \
            --title "Release v${{ github.run_number }}" \
            --notes "Production deployment of Hello World API

          **Commit:** ${{ github.sha }}
          **API Endpoint:** ${{ steps.deploy.outputs.api_endpoint }}

          ### Changes
          ${{ github.event.head_commit.message }}"

  # Rollback job (manual trigger only)
  rollback:
    name: Rollback Deployment
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Rollback to previous version
        run: |
          # Get previous stack version
          PREVIOUS_VERSION=$(aws cloudformation describe-stack-events \
            --stack-name aws-hello-world-api-prod \
            --query 'StackEvents[?ResourceStatus==`UPDATE_COMPLETE`].ResourceProperties' \
            --output text | head -n 2 | tail -n 1)

          echo "Rolling back to previous version..."
          # Implement rollback logic here
          echo "⚠️ Manual rollback required. Previous version: $PREVIOUS_VERSION"